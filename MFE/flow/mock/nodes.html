<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="change">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></span></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>


</script>

<script type="text/x-red" data-help-name="change">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in turn.</p>
    <p>The available operations are:</p>
    <ul>
        <li><b>Set</b> - set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</li>
        <li><b>Change</b> - search &amp; replace parts of the property. If regular expressions
            are enabled, the <b>replace with</b> property can include capture groups, for
            example <code>$1</code>. Replace will only change the <b>type</b> if there
            is a complete match.</li>
        <li><b>Delete</b> - delete a property.</li>
        <li><b>Move</b> - move or rename a property.</li>
    </ul>


</script>

<script type="text/javascript">
    RED.nodes.registerType('change', {
        color: '#E2D96E',
        category: 'function',
        defaults: {
            name: {value: ''},
            rules: {value: [{t: 'set', p: 'payload', pt: 'msg', to: '', tot: 'str'}]},
            // legacy
            action: {value: ''},
            property: {value: ''},
            from: {value: ''},
            to: {value: ''},
            reg: {value: false}
        },
        inputs: 1,
        outputs: 1,
        icon: 'swap.png',
        label: function () {
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === 'replace') {
                    return this._('change.label.set', {property: 'msg.' + this.property});
                } else if (this.action === 'change') {
                    return this._('change.label.change', {property: 'msg.' + this.property});
                } else if (this.action === 'move') {
                    return this._('change.label.move', {property: 'msg.' + this.property});
                } else {
                    return this._('change.label.delete', {property: 'msg.' + this.property});
                }
            } else {
                if (this.rules.length == 1) {
                    if (this.rules[0].t === 'set') {
                        return this._('change.label.set', {property: (this.rules[0].pt || 'msg') + '.' + this.rules[0].p});
                    } else if (this.rules[0].t === 'change') {
                        return this._('change.label.change', {property: (this.rules[0].pt || 'msg') + '.' + this.rules[0].p});
                    } else if (this.rules[0].t === 'move') {
                        return this._('change.label.move', {property: (this.rules[0].pt || 'msg') + '.' + this.rules[0].p});
                    } else {
                        return this._('change.label.delete', {property: (this.rules[0].pt || 'msg') + '.' + this.rules[0].p});
                    }
                } else {
                    return this._('change.label.changeCount', {count: this.rules.length});
                }
            }
        },
        paletteLabel: RED._('dojot/change:title'),
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            var set = this._('change.action.set');
            var change = this._('change.action.change');
            var del = this._('change.action.delete');
            var move = this._('change.action.move');
            var to = this._('change.action.to');
            var search = this._('change.action.search');
            var replace = this._('change.action.replace');
            var regex = this._('change.label.regex');

            function resizeRule(rule) {
                var newWidth = rule.width();
                rule.find('.red-ui-typedInput').typedInput('width', newWidth - 150);

            }

            $('#node-input-rule-container').css('min-height', '300px').css('min-width', '450px').editableList({
                addItem: function (container, i, opt) {
                    var rule = opt;
                    if (!rule.hasOwnProperty('t')) {
                        rule = {t: 'set', p: 'payload', to: '', tot: 'str'};
                    }
                    if (rule.t === 'change' && rule.re) {
                        rule.fromt = 're';
                        delete rule.re;
                    }
                    if (rule.t === 'set' && !rule.tot) {
                        if (rule.to.indexOf('msg.') === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = 'msg';
                        } else {
                            rule.tot = 'str';
                        }
                    }
                    if (rule.t === 'move' && !rule.tot) {
                        rule.tot = 'msg';
                    }

                    var row1 = $('<div/>').appendTo(container);
                    var row2 = $('<div/>', {style: 'margin-top:8px;'}).appendTo(container);
                    var row3 = $('<div/>', {style: 'margin-top:8px;'}).appendTo(container);
                    var row4 = $('<div/>', {style: 'margin-top:8px;'}).appendTo(container);

                    var selectField = $('<select/>', {
                        class: 'node-input-rule-type',
                        style: 'width:110px; margin-right:10px;'
                    }).appendTo(row1);
                    var selectOptions = [{v: 'set', l: set}];
                    for (var i = 0; i < selectOptions.length; i++) {
                        selectField.append($('<option></option>').val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    var propertyName = $('<input/>', {class: 'node-input-rule-property-name', type: 'text'})
                        .appendTo(row1)
                        .typedInput({types: ['msg']});

                    $('<div/>', {style: 'display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;'})
                        .text(to)
                        .appendTo(row2);
                    var propertyValue = $('<input/>', {class: 'node-input-rule-property-value', type: 'text'})
                        .appendTo(row2)
                        .typedInput({default: 'str', types: ['msg', 'str', 'num', 'bool']});

                    var row3_1 = $('<div/>').appendTo(row3);
                    $('<div/>', {style: 'display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;'})
                        .text(search)
                        .appendTo(row3_1);
                    var fromValue = $('<input/>', {class: 'node-input-rule-property-search-value', type: 'text'})
                        .appendTo(row3_1)
                        .typedInput({default: 'str', types: ['msg', 'str', 'num', 'bool']});

                    var row3_2 = $('<div/>', {style: 'margin-top:8px;'}).appendTo(row3);
                    $('<div/>', {style: 'display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;'})
                        .text(replace)
                        .appendTo(row3_2);
                    var toValue = $('<input/>', {class: 'node-input-rule-property-replace-value', type: 'text'})
                        .appendTo(row3_2)
                        .typedInput({default: 'str', types: ['msg', 'str', 'num']});

                    $('<div/>', {style: 'display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;'})
                        .text(to)
                        .appendTo(row4);
                    var moveValue = $('<input/>', {class: 'node-input-rule-property-move-value', type: 'text'})
                        .appendTo(row4)
                        .typedInput({default: 'msg', types: ['msg']});

                    selectField.change(function () {
                        var width = $('#node-input-rule-container').width();
                        var type = $(this).val();
                        if (type == 'set') {
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == 'change') {
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == 'delete') {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == 'move') {
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                        resizeRule(container);
                    });

                    selectField.val(rule.t);
                    propertyName.typedInput('value', rule.p);
                    propertyName.typedInput('type', rule.pt);
                    propertyValue.typedInput('value', rule.to);
                    propertyValue.typedInput('type', rule.tot);
                    moveValue.typedInput('value', rule.to);
                    moveValue.typedInput('type', rule.tot);
                    fromValue.typedInput('value', rule.from);
                    fromValue.typedInput('type', rule.fromt);
                    toValue.typedInput('value', rule.to);
                    toValue.typedInput('type', rule.tot);
                    selectField.change();

                    var newWidth = $('#node-input-rule-container').width();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            });

            if (!this.rules) {
                var rule = {
                    t: (this.action == 'replace' ? 'set' : this.action),
                    p: this.property,
                    pt: 'msg'
                }

                if ((rule.t === 'set') || (rule.t === 'move')) {
                    rule.to = this.to;
                } else if (rule.t === 'change') {
                    rule.from = this.from;
                    rule.to = this.to;
                    rule.re = this.reg;
                }

                delete this.to;
                delete this.from;
                delete this.reg;
                delete this.action;
                delete this.property;

                this.rules = [rule];
            }

            for (var i = 0; i < this.rules.length; i++) {
                var rule = this.rules[i];
                $('#node-input-rule-container').editableList('addItem', rule);
            }
        },
        oneditsave: function () {
            var rules = $('#node-input-rule-container').editableList('items');
            var ruleset;
            var node = this;
            node.rules = [];
            rules.each(function (i) {
                var rule = $(this);
                var type = rule.find('.node-input-rule-type').val();
                var r = {
                    t: type,
                    p: rule.find('.node-input-rule-property-name').typedInput('value'),
                    pt: rule.find('.node-input-rule-property-name').typedInput('type')
                };
                if (type === 'set') {
                    r.to = rule.find('.node-input-rule-property-value').typedInput('value');
                    r.tot = rule.find('.node-input-rule-property-value').typedInput('type');
                } else if (type === 'move') {
                    r.to = rule.find('.node-input-rule-property-move-value').typedInput('value');
                    r.tot = rule.find('.node-input-rule-property-move-value').typedInput('type');
                } else if (type === 'change') {
                    r.from = rule.find('.node-input-rule-property-search-value').typedInput('value');
                    r.fromt = rule.find('.node-input-rule-property-search-value').typedInput('type');
                    r.to = rule.find('.node-input-rule-property-replace-value').typedInput('value');
                    r.tot = rule.find('.node-input-rule-property-replace-value').typedInput('type');
                }
                node.rules.push(r);
            });
        },
        oneditresize: function (size) {
            var rows = $('#dialog-form>div:not(.node-input-rule-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $('#dialog-form>div.node-input-rule-container-row');
            height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));

            $('#node-input-rule-container').editableList('height', height);
        }
    });
</script>

<!--
  Copyright 2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="geofence">
   <div class="form-row">
       <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
       <input type="text" id="node-input-name">
   </div>
   <div class="form-row">
        <label for="node-input-geopoint"><i class="fa fa-tag"/> <span data-i18n="label.geopoint"/></label>
        <input id="node-input-geopoint" type="text"/>
   </div>
   <div class="form-row">
        <label for="node-input-filter">
            <i class="fa fa-sign-in"></i> <span data-i18n="label.filter"></label>
        <select id="node-input-filter" value="true" style="width: 70%;">
            <option value="inside" data-i18n="text.inside"> </option>
            <option value="outside"  data-i18n="text.outside"> </option>
        </select>
    </div>
   <div class="form-row">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css" />
        <div id="node-geofence-map" style="width: 100%; height: 400px"></div>
    </div>








</script>


<script type="text/x-red" data-help-name="geofence">
    <p>A simple geofence filter node</p>
    <p>It supports polygons only, and will filter all messages that either fall inside, outside the region or when the device
        enters or exits the region, depending on the selected mode.
    </p>
    <p>If the node is given a name property then
        <b>msg.location.isat</b> will be an array containing a list of named areas that the point is inside of and
        <b>msg.location.distance</b>
        will contain an array of name, distance pairs. Where distance is the dinstance in metres to from the point to the centroid
        of the region.</p>
    <p>This node requires inputs with
        <i>msg.location.lat</i> &amp;
        <i>msg.location.lon</i>
        or
        <i>msg.lat</i> &amp;
        <i>msg.lon</i> values.</p>



</script>

<script type="text/javascript">
    RED.nodes.registerType('geofence', {
        category: RED._('dojot/geofence:category'),
        color: '#DEBD5C',
        icon: 'white-globe.png',
        defaults: {
            name: {
                value: '', required: false
            },
            mode: {
                value: 'polyline'
            },
            filter: {
                value: 'inside'
            },
            points: {
                value: []
            },
            geopoint: {
                value: ''
            },
        },
        inputs: 1,
        outputs: 1,
        label: function () {
            return this.name || RED._('dojot/geofence:title');
        },
        paletteLabel: RED._('dojot/geofence:title'),

        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {

            $('#node-input-geopoint').typedInput({default: 'msg', types: ['msg']});

            function setupMap(node) {
                var map = L.map('node-geofence-map').setView([-22.9223, -47.0406], 7);

                window.node_geofence_map = map;

                // TODO: Change map data source
                L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 20,
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
                }).addTo(map);

                var drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);

                var drawControl = new L.Control.Draw({
                    draw: {
                        position: 'topleft',
                        polyline: false,
                        marker: false,
                        circle: false,
                        circlemarker: false
                    },
                    edit: false
                });
                map.addControl(drawControl);

                var drawControl2 = new L.Control.Draw({
                    draw: false,
                    edit: {
                        featureGroup: drawnItems
                    }
                });

                map.on('draw:created', function (e) {
                    console.log('created', e);
                    var type = e.layerType; // never used ???
                    var layer = e.layer;
                    layer.shape = 'geofence';
                    drawnItems.addLayer(layer);
                    drawControl.remove();
                    drawControl2.addTo(map);
                });

                map.on('draw:edited', function (e) {
                    console.log('edited', e);
                    var layers = e.layers;
                    layers.eachLayer(function (layer) {
                        layer.shape = 'geofence';
                        drawnItems.addLayer(layer);
                    });
                });

                map.on('draw:deleted', function (e) {
                    console.log('deleted', e);
                    //re-enable drawing
                    drawControl2.remove();
                    drawControl.addTo(map);
                });

                // new L.Control.GeoSearch({
                //     provider: new L.GeoSearch.Provider.OpenStreetMap(),
                //     position: 'bottomleft',
                //     showMarker: false,
                //     zoomLevel: 12
                // }).addTo(map);

                if (node.points.length >= 3) {
                    var corners = [];
                    for (x in node.points) {
                        var latlng = L.latLng(node.points[x].latitude, node.points[x].longitude);
                        corners.push(latlng);
                    }
                    var poly = L.polygon(
                        corners
                    );
                    poly.addTo(drawnItems);
                    map.fitBounds(
                        poly.getBounds(), {
                            padding: L.point(30, 30)
                        }
                    );
                    drawControl.remove();
                    drawControl2.addTo(map);
                }

                map.invalidateSize(true);
            }

            // TODO: Change this paths to an adequate value for dojot
            var n = this;
            console.log('loading leaflet');
            // $.getScript('mashup/geofence/js/leaflet/leaflet-src.js')
            $.getScript('https://unpkg.com/leaflet@1.3.1/dist/leaflet.js')
                .done(function (data, textStatus, jqxhr) {
                    // $.getScript('mashup/geofence/js/Leaflet.draw/dist/leaflet.draw.js')
                    $.getScript('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.js')
                        .done(function (data, textStatus, jqxhr) {
                            setupMap(n);

                            // $.getScript('mashup/geofence/js/L.GeoSearch/src/js/l.control.geosearch.js')
                            //     .done(function (data, textStatus, jqxhr) {
                            //         $.getScript('mashup/geofence/js/L.GeoSearch/src/js/l.geosearch.provider.openstreetmap.js')
                            //             .done(function (data, textStatus, jqxhr) {
                            //                 setupMap(n);
                            //             })
                            //             .fail(function (jqxhr, settings, exception) {
                            //                 console.log("failed4");
                            //                 console.log(exception);
                            //                 console.log(exception.stack);
                            //             });
                            //     })
                            //     .fail(function (jqxhr, settings, exception) {
                            //         console.log("failed3");
                            //         console.log(exception);
                            //         console.log(exception.stack);
                            //     });
                        })
                        .fail(function (jqxhr, settings, exception) {
                            console.log('failed2');
                            console.log(exception);
                            console.log(exception.stack);
                        });
                })
                .fail(function (jqxhr, settings, exception) {
                    console.log('failed');
                    console.log(exception);
                    console.log(exception.stack);
                });
        },

        oneditsave: function () {
            var map = window.node_geofence_map;
            var n = this;

            map.eachLayer(function (layer) {
                if (layer.shape === 'geofence') {
                    // console.log("GeoJSON");
                    // console.log(layer.toGeoJSON(), layer);
                    n.mode = 'polyline';
                    n.points = [];
                    n.rad = 0;
                    n.centre = {};
                    for (let x of layer._latlngs) {
                        for (let y of x) {
                            n.points.push({
                                latitude: y.lat,
                                longitude: y.lng
                            });
                        }
                    }
                }
            });
            delete window.node_geofence_map;
        },

        oneditresize: function () {
            if (window.node_geofence_map) {
                window.node_geofence_map.invalidateSize(true);
            }
        }
    });
</script>

<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="http">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
        <option value="use" data-i18n="httpin.setby"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input id="node-input-url" type="text" placeholder="http://">
    </div>

    <!--
    <div class="form-row">
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-useAuth" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useAuth" style="width: 70%;"><span data-i18n="httpin.basicauth"></span></label>
        <div style="margin-left: 20px" class="node-input-useAuth-row hide">
            <div class="form-row">
                <label for="node-input-user"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-input-user">
            </div>
            <div class="form-row">
                <label for="node-input-password"><i class="fa fa-lock"></i> <span data-i18n="common.label.password"></span></label>
                <input type="password" id="node-input-password">
            </div>
        </div>
    </div>
    -->
    <div class="form-row">
      <label for="node-input-body"><i class="fa fa-envelope"></i> <span data-i18n="httpin.label.body"></span></label>
      <input type="text" id="node-input-body" data-i18n="[placeholder]httpin.label.body">
    </div>

    <div class="form-row">
        <label for="node-input-response"><i class="fa fa-envelope"></i> <span data-i18n="httpin.label.response"></span></label>
        <input type="text" id="node-input-response" data-i18n="[placeholder]httpin.label.response">
    </div>

    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-arrow-left"></i> <span data-i18n="httpin.label.return"></span></label>
        <select type="text" id="node-input-ret" style="width:70%;">
        <option value="txt" data-i18n="httpin.utf8"></opti  on>
        <option value="bin" data-i18n="httpin.binary"></option>
        <option value="obj" data-i18n="httpin.json"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="httpin.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]httpin.label.name">
    </div>
    <div class="form-tips" id="tip-json" hidden><span data-i18n="httpin.tip.req"></span></div>

</script>

<script type="text/x-red" data-help-name="http">
    <p>Sends HTTP requests and returns the response.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">url <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the url of the request.</dd>
        <dt class="optional">method <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the HTTP method of the request.
            Must be one of <code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>PATCH</code> or <code>DELETE</code>.</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>Sets the HTTP headers of the request.</dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>If set, can be used to send cookies with the request.</dd>
        <dt class="optional">payload</dt>
        <dd>Sent as the body of the request.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | object | buffer</span></dt>
        <dd>The body of the response. The node can be configured to return the body
             as a string, attempt to parse it as a JSON string or leave it as a
             binary buffer.</dd>
        <dt>statusCode <span class="property-type">number</span></dt>
        <dd>The status code of the response, or the error code if the request could not be completed.</dd>
        <dt>headers <span class="property-type">object</span></dt>
        <dd>An object containing the response headers.</dd>
        <dt>responseUrl <span class="property-type">string</span></dt>
        <dd>In case any redirects occurred while processing the request, this property is the final redirected url.
            Otherwise, the url of the original request.</dd>
        <dt>responseCookies <span class="property-type">object</span></dt>
        <dd>If the response includes cookies, this propery is an object of name/value pairs for each cookie.</dd>
    </dl>
    <h3>Details</h3>
    <p>When configured within the node, the URL property can contain <a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache-style</a> tags. These allow the
    url to be constructed using values of the incoming message. For example, if the url is set to
    <code>example.com/{{{topic}}}</code>, it will have the value of <code>msg.topic</code> automatically inserted.
    Using {{{...}}} prevents mustache from escaping characters like / & etc.</p>
    <p><b>Note</b>: If running behind a proxy, the standard <code>http_proxy=...</code> environment variable should be set and Node-RED restarted.</p>
    <h4>Using multiple HTTP Request nodes</h4>
    <p>In order to use more than one of these nodes in the same flow, care must be taken with
    the <code>msg.headers</code> property. The first node will set this property with
    the response headers. The next node will then use those headers for its request - this
    is not usually the right thing to do. If <code>msg.headers</code> property is left unchanged
    between nodes, it will be ignored by the second node. To set custom headers, <code>msg.headers</code>
    should first be deleted or reset to an empty object: `{}`.
    <h4>Cookie handling</h4>
    <p>The <code>cookies</code> property passed to the node must be an object of name/value pairs.
    The value can be either a string to set the value of the cookie or it can be an
    object with a single <code>value</code> property.<p>
    <p>Any cookies returned by the request are passed back under the <code>responseCookies</code> property.</p>
    <h4>Content type handling</h4>
    <p>If <code>msg.payload</code> is an Object, the node will automatically set the content type
    of the request to <code>application/json</code> and encode the body as such.</p>
    <p>To encode the request as form data, <code>msg.headers["content-type"]</code> should be set to <code>application/x-www-form-urlencoded</code>.</p>


</script>

<script type="text/javascript">
    RED.nodes.registerType('http', {
        category: 'output',
        color: 'rgb(231, 231, 174)',
        defaults: {
            name: {value: ''},
            method: {value: 'GET'},
            ret: {value: 'txt'},
            body: {value: ''},
            response: {value: ''},
            url: {
                value: '', validate: function (v) {
                    return (v.trim().length === 0) || (v.indexOf('://') === -1) || (v.trim().indexOf('http') === 0)
                }
            }
            // tls: {type:"tls-config",required: false}
        },
        inputs: 1,
        outputs: 1,
        icon: 'white-globe.png',
        label: function () {
            return this.name || this._('httpin.httpreq');
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: function () {
            return this.name || this._('httpin.httpreq');
        },
        oneditprepare: function () {
            // $("#node-input-useAuth").change(function() {
            //     if ($(this).is(":checked")) {
            //         $(".node-input-useAuth-row").show();
            //     } else {
            //         $(".node-input-useAuth-row").hide();
            //         $('#node-input-user').val('');
            //         $('#node-input-password').val('');
            //     }
            // });
            // if (this.credentials.user || this.credentials.has_password) {
            //     $('#node-input-useAuth').prop('checked', true);
            // } else {
            //     $('#node-input-useAuth').prop('checked', false);
            // }
            // $("#node-input-useAuth").change();

            // function updateTLSOptions() {
            //     if ($("#node-input-usetls").is(':checked')) {
            //         $("#node-row-tls").show();
            //     } else {
            //         $("#node-row-tls").hide();
            //     }
            // }
            // if (this.tls) {
            //     $('#node-input-usetls').prop('checked', true);
            // } else {
            //     $('#node-input-usetls').prop('checked', false);
            // }
            // updateTLSOptions();
            // $("#node-input-usetls").on("click",function() {
            //     updateTLSOptions();
            // });
            $('#node-input-ret').change(function () {
                if ($('#node-input-ret').val() === 'obj') {
                    $('#tip-json').show();
                } else {
                    $('#tip-json').hide();
                }
            });
            $('#node-input-body').typedInput({default: 'msg', types: ['msg']});
            $('#node-input-response').typedInput({default: 'msg', types: ['msg']});
        },
    });
</script>

<!--
  Copyright JS Foundation and other contributors, ftp://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  ftp://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="ftp">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="ftpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="PUT">PUT</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"/> <span data-i18n="ftpin.label.url"/></label>
        <input id="node-input-url" type="text" placeholder="ftp://"/>
    </div>


    <div class="form-row">
        <label for="node-input-authentication" style="width: 70%;"><span data-i18n="ftpin.label.authentication"/></label>
        <div id="node-input-authentication" style="margin-left: 20px">
            <div class="form-row">
                <label for="node-input-username"><i class="fa fa-user"/> <span data-i18n="ftpin.label.username"/></label>
                <input id="node-input-username" type="text" placeholder="dojot"/>
            </div>
            <div class="form-row">
                <label for="node-input-password"><i class="fa fa-user"/> <span data-i18n="ftpin.label.password"/></label>
                <input id="node-input-password" type="password" placeholder="dojot"/>
            </div>
        </div>
    </div>


    <div class="form-row">
        <label for="node-input-filename"><i class="fa fa-tag"/> <span data-i18n="ftpin.label.filename"/></label>
        <input id="node-input-filename" type="text"/>
    </div>

    <div class="form-row">
        <label for="node-input-filecontent"><i class="fa fa-envelope"/> <span data-i18n="ftpin.label.filecontent"/></label>
        <input id="node-input-filecontent" type="text"/>
        <label for="node-input-fileencoding"><i class="fa fa-envelope"/> <span data-i18n="ftpin.label.fileencoding"/></label>
         <select type="text" id="node-input-fileencoding" style="width: 70%;">
            <option value="ascii">ascii</option>
            <option value="base64">base64</option>
            <option value="hex">hex</option>
            <option value="utf16le">utf16le</option>
            <option value="utf8">utf8</option>
            <option value="binary">binary</option>
        </select>
    </div>

    <div class="form-row">
            <label for="node-input-response"><i class="fa fa-tag"/> <span data-i18n="ftpin.label.response"/></label>
            <input id="node-input-response" type="text"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="ftpin.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]ftpin.label.name">
    </div>


</script>

<script type="text/x-red" data-help-name="ftp">
    <p>Sends ftp requests and returns the response.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="mandatory">url <span class="property-type">string</span></dt>
        <dd>The target URL</dd>
        <dt class="mandatory">method <span class="property-type">string</span></dt>
        <dd>Sets which operation should be performed. If <code>PUT</code>, then "filename" will refer to the remote
            filename (and content will be what should be uploaded). If <code>GET</code>, then "filename" refers to which
            file should be downloaded and "content" will be the attribute that will hold the file data (in base64 format).</dd>
        <dt class="mandatory">username <span class="property-type">string</span></dt>
        <dd>FTP username</dd>
        <dt class="mandatory">password <span class="property-type">string</span></dt>
        <dd>FTP password</dd>
        <dt class="mandatory">filename <span class="property-type">string</span></dt>
        <dd>Remote filename (which will be created, if method is PUT, or to be downloaded, if method is GET</dd>
        <dt class="mandatory">file content <span class="property-type">string</span></dt>
        <dd>File content to be uploaded (if method is PUT) or where file data is stored (if method is GET)</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>result <span class="property-type">string | object | buffer</span></dt>
        <dd>The body of the response. The node can be configured to return the body
             as a string, attempt to parse it as a JSON string or leave it as a
             binary buffer.</dd>
        <dt>statusCode <span class="property-type">number</span></dt>
        <dd>The status code of the response, or the error code if the request could not be completed.</dd>
    </dl>


</script>

<script type="text/javascript">
    RED.nodes.registerType('ftp', {
        category: 'output',
        color: 'rgb(231, 231, 174)',
        defaults: {
            name: {value: ''},
            method: {value: 'PUT'},
            url: {
                value: '', validate: function (v) {
                    return (v.trim().length === 0) || (v.indexOf('://') === -1) || (v.trim().indexOf('ftp') === 0)
                }
            },
            username: {value: 'dojot'},
            password: {value: 'dojot'},
            filename: {value: ''},
            filecontent: {value: ''},
            fileencoding: {value: ''},
            response: {value: ''}
        },
        inputs: 1,
        outputs: 1,
        icon: 'white-globe.png',
        label: function () {
            return this.name || RED._('dojot/ftp:title');
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/ftp:title'),
        oneditprepare: function () {
            $('#node-input-filename').typedInput({default: 'msg', types: ['msg']});
            $('#node-input-filecontent').typedInput({default: 'msg', types: ['msg']});
            $('#node-input-response').typedInput({default: 'msg', types: ['msg']});
        }
    });
</script>

<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-property"> <i class="fa fa-edit"></i> <span data-i18n="switch.label.property"></span></label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <div class="form-row">
        <select id="node-input-checkall" style="width:100%; margin-right:5px;">
            <option value="true" data-i18n="switch.checkall"></option>
            <option value="false" data-i18n="switch.stopfirst"></option>
        </select>
    </div>

</script>

<script type="text/x-red" data-help-name="switch">
    <p>A node to route messages based on property values.</p>
    <p>When a message arrives, the selected property is evaluated against each
    of the defined rules. The message is then sent to the output of <i>all</i>
    rules that pass.</p>
    <p><b>Note</b>: the <i>otherwise</i> rule applies as a "not any of" the rules preceding it.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('switch', {
        color: '#E2D96E',
        category: 'function',
        defaults: {
            name: {value: ''},
            property: {value: 'payload', required: true, validate: RED.validators.typedInput('propertyType')},
            propertyType: {value: 'msg'},
            rules: {value: [{t: 'eq', v: ''}]},
            checkall: {value: 'true', required: true},
            outputs: {value: 1}
        },
        inputs: 1,
        outputs: 1,
        icon: 'switch.png',
        label: function () {
            return this.name || RED._('dojot/switch:title');
        },
        paletteLabel: RED._('dojot/switch:title'),
        oneditprepare: function () {
            var node = this;
            var previousValueType = {value: 'prev', label: this._('inject.previous'), hasValue: false};

            $('#node-input-property').typedInput({default: this.propertyType || 'msg', types: ['msg']});
            var operators = [
                {v: 'eq', t: '=='},
                {v: 'neq', t: '!='},
                {v: 'lt', t: '<'},
                {v: 'lte', t: '<='},
                {v: 'gt', t: '>'},
                {v: 'gte', t: '>='},
                {v: 'btwn', t: this._('switch.rules.btwn')},
                {v: 'cont', t: this._('switch.rules.cont')},
                {v: 'regex', t: this._('switch.rules.regex')},
                {v: 'true', t: this._('switch.rules.true')},
                {v: 'false', t: this._('switch.rules.false')},
                {v: 'null', t: this._('switch.rules.null')},
                {v: 'nnull', t: this._('switch.rules.nnull')},
                {v: 'else', t: this._('switch.rules.else')}
            ];

            var andLabel = this._('switch.and');
            var caseLabel = this._('switch.ignorecase');

            function resizeRule(rule) {
                var newWidth = rule.width();
                var selectField = rule.find('select');
                var type = selectField.val() || '';
                var valueField = rule.find('.node-input-rule-value');
                var btwnField1 = rule.find('.node-input-rule-btwn-value');
                var btwnField2 = rule.find('.node-input-rule-btwn-value2');
                var selectWidth;
                if (type.length < 4) {
                    selectWidth = 60;
                } else if (type === 'regex') {
                    selectWidth = 147;
                } else {
                    selectWidth = 120;
                }
                selectField.width(selectWidth);
                if (type === 'btwn') {
                    btwnField1.typedInput('width', (newWidth - selectWidth - 70));
                    btwnField2.typedInput('width', (newWidth - selectWidth - 70));
                } else {
                    if (type === 'true' || type === 'false' || type === 'null' || type === 'nnull' || type === 'else') {
                        // valueField.hide();
                    } else {
                        valueField.typedInput('width', (newWidth - selectWidth - 70));
                    }
                }
            }

            $('#node-input-rule-container').css('min-height', '250px').css('min-width', '450px').editableList({
                addItem: function (container, i, opt) {
                    if (!opt.hasOwnProperty('r')) {
                        opt.r = {};
                    }
                    var rule = opt.r;
                    if (!rule.hasOwnProperty('t')) {
                        rule.t = 'eq';
                    }
                    var row = $('<div/>').appendTo(container);
                    var row2 = $('<div/>', {style: 'padding-top: 5px; padding-left: 175px;'}).appendTo(container);
                    var row3 = $('<div/>', {style: 'padding-top: 5px; padding-left: 102px;'}).appendTo(container);
                    var selectField = $('<select/>', {style: 'width:120px; margin-left: 5px; text-align: center;'}).appendTo(row);
                    for (var d in operators) {
                        selectField.append($('<option></option>').val(operators[d].v).text(operators[d].t));
                    }
                    var valueField = $('<input/>', {
                        class: 'node-input-rule-value',
                        type: 'text',
                        style: 'margin-left: 5px;'
                    }).appendTo(row).typedInput({default: 'str', types: ['str', 'num', 'msg']});
                    var btwnValueField = $('<input/>', {
                        class: 'node-input-rule-btwn-value',
                        type: 'text',
                        style: 'margin-left: 5px;'
                    }).appendTo(row).typedInput({default: 'num', types: ['num', 'msg']});
                    var btwnAndLabel = $('<span/>', {class: 'node-input-rule-btwn-label'}).text(' ' + andLabel + ' ').appendTo(row3);
                    var btwnValue2Field = $('<input/>', {
                        class: 'node-input-rule-btwn-value2',
                        type: 'text',
                        style: 'margin-left:2px;'
                    }).appendTo(row3).typedInput({default: 'num', types: ['num', 'msg']});
                    var finalspan = $('<span/>', {style: 'float: right;margin-top: 6px;'}).appendTo(row);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">' + (i + 1) + '</span> ');
                    var caseSensitive = $('<input/>', {
                        id: 'node-input-rule-case-' + i,
                        class: 'node-input-rule-case',
                        type: 'checkbox',
                        style: 'width:auto;vertical-align:top'
                    }).appendTo(row2);
                    $('<label/>', {
                        for: 'node-input-rule-case-' + i,
                        style: 'margin-left: 3px;'
                    }).text(caseLabel).appendTo(row2);
                    selectField.change(function () {
                        resizeRule(container);
                        var type = selectField.val();
                        if (type === 'btwn') {
                            valueField.typedInput('hide');
                            btwnValueField.typedInput('show');
                        } else {
                            btwnValueField.typedInput('hide');
                            if (type === 'true' || type === 'false' || type === 'null' || type === 'nnull' || type === 'else') {
                                valueField.typedInput('hide');
                            } else {
                                valueField.typedInput('show');
                            }
                        }
                        if (type === 'regex') {
                            row2.show();
                            row3.hide();
                        } else if (type === 'btwn') {
                            row2.hide();
                            row3.show();
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                    });
                    selectField.val(rule.t);
                    if (rule.t == 'btwn') {
                        btwnValueField.typedInput('value', rule.v);
                        btwnValueField.typedInput('type', rule.vt || 'num');
                        btwnValue2Field.typedInput('value', rule.v2);
                        btwnValue2Field.typedInput('type', rule.v2t || 'num');
                    } else if (typeof rule.v != 'undefined') {
                        valueField.typedInput('value', rule.v);
                        valueField.typedInput('type', rule.vt || 'str');
                    }
                    if (rule.case) {
                        caseSensitive.prop('checked', true);
                    } else {
                        caseSensitive.prop('checked', false);
                    }
                    selectField.change();
                },
                removeItem: function (opt) {
                    if (opt.hasOwnProperty('i')) {
                        var removedList = $('#node-input-rule-container').data('removedList') || [];
                        removedList.push(opt.i);
                        $('#node-input-rule-container').data('removedList', removedList);
                    }

                    var rules = $('#node-input-rule-container').editableList('items');
                    rules.each(function (i) {
                        $(this).find('.node-input-rule-index').html(i + 1);
                    });
                },
                resizeItem: resizeRule,
                sortItems: function (rules) {
                    var rules = $('#node-input-rule-container').editableList('items');
                    rules.each(function (i) {
                        $(this).find('.node-input-rule-index').html(i + 1);
                    });
                },
                sortable: true,
                removable: true
            });

            for (var i = 0; i < this.rules.length; i++) {
                var rule = this.rules[i];
                $('#node-input-rule-container').editableList('addItem', {r: rule, i: i});
            }
        },
        oneditsave: function () {
            var rules = $('#node-input-rule-container').editableList('items');
            var ruleset;
            var node = this;
            node.rules = [];
            var changedOutputs = {};
            var removedList = $('#node-input-rule-container').data('removedList') || [];
            removedList.forEach(function (i) {
                changedOutputs[i] = -1;
            });
            rules.each(function (i) {
                var ruleData = $(this).data('data');
                var rule = $(this);
                var type = rule.find('select').val();
                var r = {t: type};
                if (!(type === 'true' || type === 'false' || type === 'null' || type === 'nnull' || type === 'else')) {
                    if (type === 'btwn') {
                        r.v = rule.find('.node-input-rule-btwn-value').typedInput('value');
                        r.vt = rule.find('.node-input-rule-btwn-value').typedInput('type');
                        r.v2 = rule.find('.node-input-rule-btwn-value2').typedInput('value');
                        r.v2t = rule.find('.node-input-rule-btwn-value2').typedInput('type');
                    } else {
                        r.v = rule.find('.node-input-rule-value').typedInput('value');
                        r.vt = rule.find('.node-input-rule-value').typedInput('type');
                    }
                    if (type === 'regex') {
                        r.case = rule.find('.node-input-rule-case').prop('checked');
                    }
                }
                if (ruleData.hasOwnProperty('i')) {
                    if (ruleData.i !== i) {
                        changedOutputs[ruleData.i] = i;
                    }
                }
                node.rules.push(r);
            });
            this._outputs = changedOutputs;
            this.outputs = node.rules.length;
            this.propertyType = $('#node-input-property').typedInput('type');
        },
        oneditresize: function (size) {
            var rows = $('#dialog-form>div:not(.node-input-rule-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $('#dialog-form>div.node-input-rule-container-row');
            height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
            $('#node-input-rule-container').editableList('height', height);
        }
    });
</script>

<script type="text/x-red" data-template-name="template">
    <div class="form-row">
            <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
            <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-field"><i class="fa fa-edit"></i> <span data-i18n="label.property"></span></label>
        <input type="text" id="node-input-field" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row">
        <label for="node-input-syntax"><i class="fa fa-code"></i> <span data-i18n="label.syntax"></span></label>
        <select id="node-input-syntax" style="width:180px;">
            <option value="handlebars" data-i18n="label.handlebars"></option>
            <option value="plain" data-i18n="label.plain"></option>
            <option value="mustache" data-i18n="label.mustache"></option>
        </select>
    </div>

    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-long-arrow-right"></i> <span data-i18n="label.output"></span></label>
        <select id="node-input-output" style="width:180px;">
            <option value="str" data-i18n="label.plain"></option>
            <option value="json" data-i18n="label.json"></option>
        </select>
    </div>


</script>

<script type="text/x-red" data-help-name="template">
    <p>Sets a property based on the provided template.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>A msg object containing information to populate the template.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>a msg with a property set by populating the configured template with properties from the incoming msg.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default this uses the <i><a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache</a></i>
    format, but this can be switched off if required.</p>
    <p>For example, when a template of:
    <pre>Hello {{payload.name}}. Today is {{date}}</pre>
    <p>receives a message containing:
    <pre>{
  date: "Monday"
  payload: {
    name: "Fred",
  }
}</pre>
    <p>The resulting property will be:
    <pre>Hello Fred. Today is Monday</pre>
    <p>It is possible to use a property from the flow context or global context. Just use <code>{{flow.name}}</code> or <code>{{global.name}}</code>.
    <p><b>Note: </b>By default, <i>mustache</i> will escape any HTML entities in the values it substitutes.
       To prevent this, use <code>{{{triple}}}</code> braces.

</script>

<script type="text/javascript">
    RED.nodes.registerType('template', {
        color: 'rgb(243, 181, 103)',
        category: 'function',
        defaults: {
            name: {value: ''},
            field: {value: 'payload', validate: RED.validators.typedInput('fieldType')},
            fieldType: {value: 'msg'},
            syntax: {value: 'handlebars'},
            template: {value: RED._('dojot/template:template_value') + ' {{{stringify payload}}} !'},
            output: {value: 'str'}
        },
        paletteLabel: RED._('dojot/template:template'),
        inputs: 1,
        outputs: 1,
        icon: 'template.png',
        label: function () {
            return this.name || RED._('dojot/template:template');
        },
        oneditprepare: function () {
            var that = this;
            if (!this.fieldType) {
                this.fieldType = 'msg';
            }
            if (!this.syntax) {
                this.syntax = 'handlebars';
                $('#node-input-syntax').val(this.syntax);
            }
            $('#node-input-field').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-fieldType')
            });

            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/html',
                value: $('#node-input-template').val()
            });
            RED.library.create({
                url: 'functions', // where to get the data from
                type: 'function', // the type of object the library is for
                editor: that.editor, // the field name the main text body goes to
                fields: ['name', 'outputs']
            });
            this.editor.focus();
        },
        oneditsave: function () {
            $('#node-input-template').val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function (size) {
            var rows = $('#dialog-form>div:not(.node-text-editor-row)');
            var height = $('#dialog-form').height();
            for (var i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $('#dialog-form>div.node-text-editor-row');
            height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
            $('.node-text-editor').css('height', height + 'px');
            this.editor.resize();
        }
    });
</script>

<script type="text/x-red" data-template-name="event device in">
   <div class="form-row">
       <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
       <input type="text" id="node-input-name">
   </div>

  <div class="form-row">
    <label for="node-input-device"><i class="fa fa-wifi"></i> <span data-i18n="label.device"></label>
    <input type="text" list="node-input-list_device_id"
      id="node-input-device" data-i18n="[placeholder]text.select_device" />
    <datalist id="node-input-list_device_id"></datalist>
  </div>

  <div class="form-row">
    <label><i class="fa fa-bell" /> <span data-i18n="label.events">:</label>
  </div>
  <div class="form-row">
    <label for="node-input-event_configure"><i class="fa" /> <span data-i18n="events.actuate"></label>
    <input type="checkbox" id="node-input-event_configure">
  </div>
  <div class="form-row">
    <label for="node-input-event_publish"><i class="fa" /> <span data-i18n="events.publish"></label>
    <input type="checkbox" id="node-input-event_publish">
  </div>

</script>

<script type="text/x-red" data-help-name="event device in">
   <p>Use data retrieved from a previously configured sensor as input to logic.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('event device in', {
        category: 'input',      // the palette category
        defaults: {
            // defines the editable properties of the node
            // just the UI label displayed back to the user on the flow.
            name: {value: '', required: false},

            event_configure: {value: false, required: true},
            event_publish: {value: false, required: true},

            device_id: {value: '', required: false}
        },
        inputs: 0,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: 'left',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/event-device-in:title');
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/event-device-in:title'),
        oneditprepare: function () {
            var listDevices = $('#node-input-list_device_id');
            let node = this;

            // request to the device manager all devices
            async function list_all(page) {
                return new Promise((resolve, reject) => {
                    if (!page) {
                        page = 1;
                    }

                    let extra = `?page_num=${page}`
                    let orderByLabel = 'sortBy=label';

                    extra += '&' + orderByLabel;

                    util.GET(`/device${extra}`).then((list) => {
                        list.devices.map((dev) => {
                            listDevices.append('<option data-value="' + dev.id +
                                '" value="' + dev.label + ' (' + dev.id + ')"/>');
                        });
                        if (list.pagination.has_next) {
                            return list_all(list.pagination.next_page).then(() => {
                                return resolve();
                            });
                        } else {
                            node._devices_loaded = true;
                            return resolve();
                        }
                    }).catch((error) => {
                        console.error(`Failed to retrieve the list of available devices. Error ${error}`);
                        node._devices_loaded = false;
                        return reject();
                    });
                });
            }

            list_all().then(() => {
                if (node.device_id !== '') {
                    let selectedDevice = $('#node-input-device');
                    let configuredDeviceEntry = listDevices.find('option[data-value="' + node.device_id + '"]');
                    if (configuredDeviceEntry.attr('value')) {
                        selectedDevice.val(configuredDeviceEntry.attr('value'));
                    } else {
                        selectedDevice.val(`Missing device: ${node.device}`);
                    }
                }
            });
        },
        oneditsave: function () {
            let node = this;
            let selectedDevice = $('#node-input-device');
            let entry = $('#node-input-list_device_id').find(
                'option[value="' + selectedDevice.val() + '"]');
            if (entry.attr('data-value')) {
                let deviceId = entry.attr('data-value');
                if (deviceId) {
                    node.device_id = deviceId;
                } else {
                    console.log('Cannot save device: invalid value');
                }
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="device in">
   <div class="form-row">
       <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
       <input type="text" id="node-input-name">
   </div>
   <div class="form-row">
       <label for="node-input-device"><i class="fa fa-wifi"></i> <span data-i18n="label.device"></label>
       <input type="text" list="node-input-list_devices_id" id="node-input-device_source_id" data-i18n="[placeholder]text.select_device" />
       <datalist id="node-input-list_devices_id"></datalist>
   </div>
   <div class="form-row">
       <label for="node-input-status"><i class="fa fa-bell" /> <span data-i18n="label.status"></label>
       <select id="node-input-status" value='false' style="width: 70%;">
            <option value='false' data-i18n="text.exclude"></option>
            <option value='true' data-i18n="text.include"></option>
        </select>
   </div>
   <div style="display:none">
       <input type='text' id='node-input-_device_id'/>
       <input type='text' id='node-input-_device_label'/>
       <input type='text' id='node-input-_device_type'/>
   </div>

</script>

<script type="text/x-red" data-help-name="device in">
   <p>Use data retrieved from a previously configured sensor as input to logic.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('device in', {
        category: 'deprecated_nodes',      // the palette category
        defaults: {
            // defines the editable properties of the node
            // just the UI label displayed back to the user on the flow.
            name: {value: '', required: false},
            // name of the device which data is retrieved from.
            device_source_id: {value: '', required: true},
            status: {value: 'false', required: true},

            // those are the internal types used when routing data through fiware.
            _device_id: {value: undefined, required: false},
            _device_label: {value: undefined, required: false},
            _device_type: {value: undefined, required: false},
        },
        inputs: 0,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: 'left',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/device-in:title');
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/device-in:title'),
        oneditprepare: function () {
            var listDevices = $('#node-input-list_devices_id');

            // this will only work from the device management interface
            function list_all(page) {

                if (page === undefined) {
                    page = 1;
                }

                var extra = `?page_num=${page}`
                var orderByLabel = 'sortBy=label';

                extra += '&' + orderByLabel;

                util.GET(`/device${extra}`).then((list) => {
                    list.devices.map((dev) => {
                        listDevices.append('<option data-value="' + dev.id +
                            '" value="' + dev.label + ' (' + dev.id + ')"/>');
                    });
                    if (list.pagination.has_next) {
                        list_all(list.pagination.next_page);
                    }
                }).catch((error) => {
                    console.error('Failed to retrieve the list of available devices', error);
                });

            }

            list_all();
        },
        oneditsave: function () {
            let deviceLabel = $('#node-input-device_source_id').val();

            let deviceId = $('#node-input-list_devices_id').find(
                'option[value="' + deviceLabel + '"]').attr('data-value');

            if (!deviceId) {
                $('#node-input-_device_id').val(undefined);
            } else {
                $('#node-input-_device_id').val(deviceId);
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="device out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-gears"></i> <span data-i18n="label.action"></label>
        <select id="node-input-device_source" onchange="displayDeviceSourceElement()">
            <option value="self"  data-i18n="label.self"></option>
            <option value="configured"  data-i18n="label.configured"></option>
            <option value="dynamic"  data-i18n="label.dynamic"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-device_source_msg" id="node-input-device_source_msg_label"><i class="fa fa-tag"></i> <span data-i18n="label.attribute"></label>
        <input type="text" id="node-input-device_source_msg" data-i18n="[placeholder]text.attr_placeholder" />
        <label for="node-input-device_source_id" id="node-input-device_source_id_label"><i class="fa fa-wifi"></i> <span data-i18n="label.device"></label>
        <input type="text" list="node-input-list_devices_id" id="node-input-device_source_id" data-i18n="[placeholder]text.select_dev_placeholder" />
        <datalist id="node-input-list_devices_id"></datalist>
    </div>

    <div class="form-row">
        <label for="node-input-attrs"><i class="fa fa-cube"></i> <span data-i18n="label.source"></label>
        <input type="text" id="node-input-attrs" style=""></input>
    </div>

    <div style="display:none">
        <input type='text' id='node-input-_device_id'/>
    </div>

</script>

<script type="text/x-red" data-help-name="device out">
    <p><span data-i18n="text.help"></p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('device out', {
        category: 'deprecated_nodes',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: {value: '', required: false},
            device_source: {value: 'self', required: true},
            device_source_msg: {value: '', required: false},
            device_source_id: {value: '', required: false},
            attrs: {value: '', required: true},

            // those are the internal types
            _device_id: {value: undefined, required: false}
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 0,               // set the number of outputs - 0 to n
        align: 'right',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || 'device';
            return this.name || RED._('dojot/device-out:label.device_out');
        },
        paletteLabel: RED._('dojot/device-out:label.device_out'),
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            var listDevices = $('#node-input-list_devices_id');

            displayDeviceSourceElement();

            // this will only work from the device management interface
            function list_all(page) {
                if (page === undefined) {
                    page = 1;
                }

                var extra = `?page_num=${page}`
                var orderByLabel = 'sortBy=label';

                extra += '&' + orderByLabel;

                util.GET(`/device${extra}`).then((list) => {
                    list.devices.map((dev) => {
                        listDevices.append('<option data-value="' + dev.id +
                            '" value="' + dev.label + ' (' + dev.id + ')"/>');
                    });
                    if (list.pagination.has_next) {
                        list_all(list.pagination.next_page);
                    }
                }).catch((error) => {
                    console.error('Failed to retrieve the list of available devices', error);
                });
            }

            $('#node-input-device_source').css('width', '70%');

            list_all();
        },
        oneditsave: function () {
            if ($('#node-input-device_source').val() === 'configured') {
                let deviceLabel = $('#node-input-device_source_id').val();

                let deviceId = $('#node-input-list_devices_id').find(
                    'option[value="' + deviceLabel + '"]').attr('data-value');

                if (!deviceId) {
                    $('#node-input-_device_id').val(undefined);
                } else {
                    $('#node-input-_device_id').val(deviceId);
                }
            } else {
                $('#node-input-_device_id').val(undefined);
            }
        }
    });

    function displayDeviceSourceElement() {
        var deviceSource = $('#node-input-device_source');
        var deviceSourceId = $('#node-input-device_source_id');
        var deviceSourceMsg = $('#node-input-device_source_msg');
        var deviceSourceIdLabel = $('#node-input-device_source_id_label');
        var deviceSourceMsgLabel = $('#node-input-device_source_msg_label');

        switch (deviceSource.val()) {
            case 'self':
                deviceSourceId.hide();
                deviceSourceMsg.hide();
                deviceSourceIdLabel.hide();
                deviceSourceMsgLabel.hide();
                break;
            case 'configured':
                deviceSourceId.show();
                deviceSourceMsg.hide();
                deviceSourceIdLabel.show();
                deviceSourceMsgLabel.hide();
                break;
            case 'dynamic':
                deviceSourceId.hide();
                deviceSourceMsg.show();
                deviceSourceIdLabel.hide();
                deviceSourceMsgLabel.show();
                break;
        }
    }

</script>

<script type="text/x-red" data-template-name="multi device out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-device_source"><i class="fa fa-gears"></i> <span data-i18n="label.action"></label>
        <select id="node-input-device_source" onchange="nodeDeviceOut_displayDeviceSourceElement()">
            <option value="self" data-i18n="text.triggered"></option>
            <option value="configured" data-i18n="text.specific"></option>
            <option value="dynamic" data-i18n="text.defined"></option>
        </select>
    </div>
    <div class="form-row" id="node-input-dynamic">
        <label for="node-input-devices_source_dynamic" id="node-input-devices_source_dynamic_label"><i class="fa fa-tag"></i> <span data-i18n="label.attribute"></label>
        <input type="text" id="node-input-devices_source_dynamic" data-i18n="[placeholder]text.enter_attribute" />
        <input type="hidden" id="node-input-devices_source_dynamicFieldType">
    </div>
    <div class="form-row" id="node-input-configured">
        <label for="form-row node-input-rule-container-row" id="node-input-devices_source_configured_label"><i class="fa fa-wifi"></i> <span data-i18n="label.devices"></label>
        <div class="form-row node-input-rule-container-row">
            <ol id="node-input-rule-container"></ol>
        </div>
        <datalist id="node-input-list_devices_id"></datalist>
    </div>
    <div class="form-row">
        <label for="node-input-attrs"><i class="fa fa-cube"></i> <span data-i18n="label.source"></label>
        <input type="text" id="node-input-attrs" style=""></input>
        <input type="hidden" id="node-input-msgFieldType">
    </div>

</script>

<script type="text/x-red" data-help-name="multi device out">
    <p>Set the value of a virtual device, based on the results of the previous operations on the flow.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('multi device out', {
        category: 'output',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: {value: '', required: false},
            device_source: {value: 'self', required: true},
            devices_source_dynamic: {value: '', required: false},
            devices_source_dynamicFieldType: {value: 'msg'},
            devices_source_configured: {value: [''], required: false},
            attrs: {value: '', required: true},

            // private
            _devices_loaded: {value: false, required: false}
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 0,               // set the number of outputs - 0 to n
        align: 'right',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/multi-device-out:title');
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/multi-device-out:title'),
        oneditprepare: function () {
            let node = this;
            let listDevices = $('#node-input-list_devices_id');
            nodeDeviceOut_displayDeviceSourceElement();

            if (!this.devices_source_dynamicFieldType) {
                this.devices_source_dynamicFieldType = 'msg';
            }
            $('#node-input-devices_source_dynamic').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-devices_source_dynamicFieldType')
            });

            $('#node-input-attrs').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-msgFieldType')
            });

            // request to the device manager all devices
            function list_all(page) {
                return new Promise((resolve, reject) => {
                    if (page === undefined) {
                        page = 1;
                    }

                    var extra = `?page_num=${page}`
                    var orderByLabel = 'sortBy=label';

                    extra += '&' + orderByLabel;

                    util.GET(`/device${extra}`).then((list) => {
                        list.devices.map((dev) => {
                            listDevices.append('<option data-value="' + dev.id +
                                '" value="' + dev.label + ' (' + dev.id + ')"/>');
                        });
                        if (list.pagination.has_next) {
                            return list_all(list.pagination.next_page).then(() => {
                                return resolve();
                            });
                        } else {
                            node._devices_loaded = true;
                            return resolve();
                        }
                    }).catch((error) => {
                        console.error('Failed to retrieve the list of available devices', error);
                        node._devices_loaded = false;
                        return reject();
                    });
                });
            }

            $('#node-input-device_source').css('width', '70%');

            list_all().then(() => {
                // define the rule box
                $('#node-input-rule-container').css('min-height', '150px').css('min-width', '450px').editableList({

                    addItem: function (container, index, data) {
                        let fieldConfig = {
                            type: 'text',
                            list: 'node-input-list_devices_id',
                            id: `node-input-device_source_id`,
                            placeholder: RED._('dojot/multi-device-out:text.select_device')
                        };

                        if (Object.entries(data).length > 0) {
                            let configuredDeviceEntry = $('#node-input-list_devices_id').find(
                                'option[data-value="' + data + '"]');
                            if (configuredDeviceEntry) {
                                fieldConfig.value = configuredDeviceEntry.attr('value');
                            } else {
                                fieldConfig.value = `Missing device: ${data}`;
                            }
                        }

                        $('<input/>', fieldConfig).appendTo(container);

                    },
                    sortable: true,
                    removable: true
                });

                // load the previous configuration
                for (let i = 0; i < node.devices_source_configured.length; ++i) {
                    $('#node-input-rule-container').editableList('addItem',
                        node.devices_source_configured[i]);
                }
            }).catch(() => {
                node._devices_loaded = false;
                console.log('Failed to retrieve devices from device manager');
            });

        },
        oneditsave: function () {
            let node = this;

            switch ($('#node-input-device_source').val()) {
                case 'configured':
                    node.devices_source_dynamic = '';

                    // skip save the devices due to problem with the device manager
                    // communication
                    if (!node._devices_loaded) {
                        console.log('Skipping save the devices');
                        return
                    }
                    // rebuilt the list with the devices ids
                    node.devices_source_configured = [];
                    let entries = $('#node-input-rule-container').editableList('items');
                    entries.each(function (i) {
                        let userLabel = this.find('#node-input-device_source_id').val();
                        let entry = $('#node-input-list_devices_id').find(
                            'option[value="' + userLabel + '"]');
                        if (entry) {
                            let deviceId = entry.attr('data-value');
                            if (deviceId) {
                                node.devices_source_configured.push(deviceId);
                            }
                        }

                    });
                    break;
                case 'self':
                    node.devices_source_configured = [''];
                    node.devices_source_dynamic = '';
                    break;
                case 'dynamic':
                    node.devices_source_configured = [''];
                    break;
            }
        }
    });

    function nodeDeviceOut_displayDeviceSourceElement() {
        let deviceSource = $('#node-input-device_source');
        let devicesSourceConfigured = $('#node-input-configured');
        let devicesSourceDynamic = $('#node-input-dynamic');

        switch (deviceSource.val()) {
            case 'self':
                devicesSourceConfigured.hide();
                devicesSourceDynamic.hide();
                break;
            case 'configured':
                devicesSourceConfigured.show();
                devicesSourceDynamic.hide();
                break;
            case 'dynamic':
                devicesSourceConfigured.hide();
                devicesSourceDynamic.show();
                break;
        }
    }

</script>

<script type="text/x-red" data-template-name="publish-ftp">
    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i> 
            <span data-i18n="label.name"></span>
        </label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-encode" style="width: 22%;">
            <i class="fa fa-file-code-o"></i> 
            <span data-i18n="label.encode"></span>
        </label>
        <select type="text" id="node-input-encode" style="width: 70%;">
            <option value="ascii">ascii</option>
            <option value="base64">base64</option>
            <option value="hex">hex</option>
            <option value="utf16le">utf16le</option>
            <option value="utf8">utf8</option>
            <option value="binary">binary</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-filename">
            <i class="fa fa-file"></i>
            <span data-i18n="label.filename"></span>
        </label>
        <input type="text" id="node-input-filename" />
    </div>
    <div class="form-row">
        <label for="node-input-filecontent">
            <i class="fa fa-file-text-o"></i>
            <span data-i18n="label.filecontent"></span>
        </label>
        <input type="text" id="node-input-filecontent"/>
    </div>

</script>

<script type="text/x-red" data-help-name="publish-ftp">
</script>

<script type="text/javascript">
    RED.nodes.registerType('publish-ftp', {
        category: 'output',
        color: '#D8BFD8',
        defaults: {
            name: {value: '', required: false},
            encode: {value: 'base64', required: true},
            filename: {value: '', required: true},
            filecontent: {value: '', required: true},
        },
        inputs: 1,
        outputs: 0,
        align: 'right',
        icon: 'inject.png',
        label: function () {
            return this.name || RED._('dojot/publish-ftp:title');
        },
        paletteLabel: RED._('dojot/publish-ftp:title'),
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            $('#node-input-filecontent').typedInput({default: 'msg', types: ['msg']});
            $('#node-input-filename').typedInput({default: 'msg', types: ['msg']});
        },
        oneditsave: function () {
        }
    });
</script>
<script type="text/x-red" data-template-name="notification">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-msgType"><i class="fa fa-gears"></i> <span data-i18n="label.message"></label>
        <select id="node-input-msgType" onchange="handleChangeMsgType()" style="width:70%;">
            <option value="static" data-i18n="text.static"></option>
            <option value="dynamic" data-i18n="text.dynamic"></option>
        </select>
    </div>
    <div class="form-row" id="notification-static-message" >
        <label for="node-input-messageStatic"><i class="fa fa-edit"></i> <span data-i18n="label.value"></label>
        <textarea id="node-input-messageStatic" style="width:70%;"></textarea>
    </div>
    <div class="form-row" id="notification-dynamic-message">
        <label for="node-input-messageDynamic"><i class="fa fa-edit"></i> <span data-i18n="label.value"></label>
        <input type="text" id="node-input-messageDynamic">
        <input type="hidden" id="node-input-messageFieldType">
    </div>
    <div class="form-row">
        <label for="node-input-source"><i class="fa fa-cube"></i> <span data-i18n="label.source"></label>
        <input type="text" id="node-input-source">
        <input type="hidden" id="node-input-sourceFieldType">
    </div>


</script>

<script type="text/x-red" data-help-name="notification">
</script>

<script type="text/javascript">
    RED.nodes.registerType('notification', {
        category: 'output',
        color: '#87A980',
        defaults: {
            name: {value: '', required: false},
            source: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('sourceFieldType')
            },
            sourceFieldType: {value: 'msg'},
            messageDynamic: {
                value: '',
                validate: RED.validators.typedInput('messageFieldType')
            },
            messageStatic: {value: ''},
            messageFieldType: {value: 'msg'},
            msgType: {value: 'static', required: true}
        },
        inputs: 1,
        outputs: 0,
        icon: 'alert.png',
        label: function () {
            return this.name || RED._('dojot/notification:title');
        },
        paletteLabel: RED._('dojot/notification:title'),
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {

            handleChangeMsgType();

            if (!this.sourceFieldType) {
                this.sourceFieldType = 'msg';
            }
            $('#node-input-source').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-sourceFieldType')
            });

            if (!this.messageFieldType) {
                this.messageFieldType = 'msg';
            }
            $('#node-input-messageDynamic').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-messageFieldType')
            });
        },
        oneditsave: function () {
        }
    });

    function handleChangeMsgType() {
        let msgType = $('#node-input-msgType');
        let staticArea = $('#notification-static-message');
        let dynamicArea = $('#notification-dynamic-message');

        switch (msgType.val()) {
            case 'dynamic':
                staticArea.hide();
                dynamicArea.show();
                break;
            case 'static':
                staticArea.show();
                dynamicArea.hide();
                break;
        }
    }
</script>

<script type="text/x-red" data-template-name="event template in">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
    <input type="text" id="node-input-name">
  </div>

  <div class="form-row">
    <label for="node-input-template"><i class="fa fa-wifi"></i> <span data-i18n="label.device_template"></label>
    <input type="text" list="node-input-list_template_id"
      id="node-input-template" data-i18n="[placeholder]text.select_template"/>
    <datalist id="node-input-list_template_id"></datalist>
  </div>

  <div class="form-row">
    <label><i class="fa fa-bell" /> <span data-i18n="label.events">:</label>
  </div>
  <div class="form-row">
    <label for="node-input-event_create"><i class="fa" /> <span data-i18n="events.create"></label>
    <input type="checkbox" id="node-input-event_create">
  </div>
  <div class="form-row">
    <label for="node-input-event_update"><i class="fa" /> <span data-i18n="events.update"></label>
    <input type="checkbox" id="node-input-event_update">
  </div>
  <div class="form-row">
    <label for="node-input-event_remove"><i class="fa" /> <span data-i18n="events.remove"></label>
    <input type="checkbox" id="node-input-event_remove">
  </div>
  <div class="form-row">
    <label for="node-input-event_configure"><i class="fa" /> <span data-i18n="events.actuate"></label>
    <input type="checkbox" id="node-input-event_configure">
  </div>
  <div class="form-row">
    <label for="node-input-event_publish"><i class="fa" /> <span data-i18n="events.publish"></label>
    <input type="checkbox" id="node-input-event_publish">
  </div>

</script>

<script type="text/x-red" data-help-name="event template in">
  <p>Use data retrieved from a previously configured sensor as input to logic.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('event template in', {
        category: 'input',      // the palette category
        defaults: {
            // defines the editable properties of the node

            // just the UI label displayed back to the user on the flow.
            name: {value: '', required: false},

            event_create: {value: false, required: true},
            event_update: {value: false, required: true},
            event_remove: {value: false, required: true},
            event_configure: {value: false, required: true},
            event_publish: {value: false, required: true},

            template_id: {value: '', required: false}
        },
        inputs: 0,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: 'left',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#679BF3',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/event-template-in:title');
        },
        paletteLabel: RED._('dojot/event-template-in:title'),
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            let listTemplates = $('#node-input-list_template_id');
            let node = this;

            // request to the device manager all templates
            async function list_all(page) {
                return new Promise((resolve, reject) => {
                    if (!page) {
                        page = 1;
                    }

                    let extra = `?page_num=${page}`
                    let orderByLabel = 'sortBy=label';

                    extra += '&' + orderByLabel;

                    util.GET(`/template${extra}`).then((list) => {
                        list.templates.map((template) => {
                            listTemplates.append('<option data-value="' + template.id +
                                '" value="' + template.label + ' (' + template.id + ')"/>');
                        });
                        if (list.pagination.has_next) {
                            return list_all(list.pagination.next_page).then(() => {
                                return resolve();
                            });
                        } else {
                            node._templates_loaded = true;
                            return resolve();
                        }
                    }).catch((error) => {
                        console.error('Failed to retrieve the list of available templates', error);
                        node._templates_loaded = false;
                        return reject();
                    });
                });
            }

            list_all().then(() => {
                if (node.template_id !== '') {
                    let selectedTemplate = $('#node-input-template');
                    let configuredTemplateEntry = listTemplates.find('option[data-value="' + node.template_id + '"]');
                    if (configuredTemplateEntry.attr('value')) {
                        selectedTemplate.val(configuredTemplateEntry.attr('value'));
                    } else {
                        selectedTemplate.val(`Missing template: ${node.template}`);
                    }
                }
            });
        },

        oneditsave: function () {
            let node = this;
            let selectedTemplate = $('#node-input-template');
            let entry = $('#node-input-list_template_id').find(
                'option[value="' + selectedTemplate.val() + '"]');
            if (entry.attr('data-value')) {
                let templateId = entry.attr('data-value');
                if (templateId) {
                    node.template_id = templateId;
                } else {
                    console.log('Cannot save template: invalid value');
                }
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="device template in">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
      <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
      <label for="node-input-device-template"><i class="fa fa-wifi"></i> <span data-i18n="label.device_template"></label>
      <select id="node-input-device-template" style=""></select>
  </div>
  <div class="form-row">
       <label for="node-input-status"><i class="fa fa-bell" /> <span data-i18n="label.status"></label>
       <select id="node-input-status" value='false' style="width: 70%;">
            <option value='false'  data-i18n="text.exclude"></option>
            <option value='true'  data-i18n="text.include"></option>
        </select>
   </div>
  <div style="display:none">
      <input type='text' id='node-input-device-template-label'/>
      <input type='text' id='node-input-device-template-id'/>
  </div>

</script>

<script type="text/x-red" data-help-name="device template in">
  <p>Use data retrieved from a previously configured sensor as input to logic.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('device template in', {
        category: 'deprecated_nodes',      // the palette category
        defaults: {
            // defines the editable properties of the node

            // just the UI label displayed back to the user on the flow.
            name: {value: '', required: false},
            // name of the device which data is retrieved from.
            device_template: {value: '', required: true},
            status: {value: 'false', required: true},

            // those are the internal types used when routing data through fiware.
            device_template_label: {value: '', required: false},
            device_template_id: {value: '', required: false}
        },
        inputs: 0,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: 'left',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#679BF3',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/device-template-in:title');
        },
        paletteLabel: RED._('dojot/device-template-in:title'),
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            var select = document.getElementById('node-input-device-template');
            let node = this;

            // this will only work from the device management interface
            function list_all(page) {
                var orderBy = 'sortBy=label';
                var extra = `?page_num=${page}&${orderBy}`
                if (page === undefined) {
                    extra = '?page_num=1&' + orderBy;
                }

                util.GET(`/template${extra}`).then((list) => {
                    list.templates.map((dev) => {
                        select.options[select.options.length] = new Option(dev.label, JSON.stringify({'id': dev.id}));
                    });
                    if (list.pagination.has_next) {
                        list_all(list.pagination.next_page);
                    } else {
                        select.value = JSON.stringify(node.device_template);
                    }
                }).catch((error) => {
                    console.error('Failed to retrieve the list of available devices', error);
                });
            }

            list_all();
        },

        oneditsave: function () {
            if ($('#node-input-device-template').val()) {
                const deviceData = JSON.parse($('#node-input-device-template').val());
                $('#node-input-device-template-label').val(deviceData.label);
                $('#node-input-device-template-id').val(deviceData.id);
                this.device_template_label = deviceData.label;
                this.device_template_id = deviceData.id;
                this.device_template = deviceData;
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="actuate">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-gears"></i> <span data-i18n="label.action"></label>
        <select id="node-input-device_source" onchange="displayDeviceSourceElement()">
            <option value="self"  data-i18n="label.self"></option>
            <option value="configured"  data-i18n="label.configured"></option>
            <option value="dynamic"  data-i18n="label.dynamic"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-device_source_msg" id="node-input-device_source_msg_label"><i class="fa fa-tag"></i> <span data-i18n="label.attribute"></label>
        <input type="text" id="node-input-device_source_msg" data-i18n="[placeholder]text.attr_placeholder" />
        <label for="node-input-device_source_id" id="node-input-device_source_id_label"><i class="fa fa-wifi"></i> <span data-i18n="label.device"></label>
        <input type="text" list="node-input-list_devices_id" id="node-input-device_source_id" data-i18n="[placeholder]text.select_dev_placeholder" />
        <datalist id="node-input-list_devices_id"></datalist>
    </div>

    <div class="form-row">
        <label for="node-input-attrs"><i class="fa fa-cube"></i> <span data-i18n="label.source"></label>
        <input type="text" id="node-input-attrs" style=""></input>
    </div>

    <div style="display:none">
        <input type='text' id='node-input-_device_id'/>
    </div>



</script>

<script type="text/x-red" data-help-name="actuate">
    <p><span data-i18n="text.value_virtual"></p>



</script>

<script type="text/javascript">
    var ACTUATOR = 'actuator';
    RED.nodes.registerType('actuate', {
        category: 'deprecated nodes',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: {value: '', required: false},
            device_source: {value: 'self', required: true},
            device_source_msg: {value: '', required: false},
            device_source_id: {value: '', required: false},
            attrs: {value: '', required: true},

            // those are the internal types
            _device_id: {value: undefined, required: false}
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 0,               // set the number of outputs - 0 to n
        align: 'right',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/actuate:label.actuate');
        },
        paletteLabel: RED._('dojot/actuate:label.actuate'),
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            var listDevices = $('#node-input-list_devices_id');

            displayDeviceSourceElement();

            // this will only work from the device management interface
            function list_all(page) {
                if (page === undefined) {
                    page = 1;
                }

                var extra = `?page_num=${page}`
                var orderByLabel = 'sortBy=label';

                extra += '&' + orderByLabel;
                var listActuate = [];
                util.GET(`/device${extra}`).then((list) => {
                    list.devices.map((dev) => {
                        for (let template in dev.attrs) {
                            for (let attr of dev.attrs[template]) {
                                if (attr.type === ACTUATOR) {
                                    listActuate.push(dev);
                                }
                            }
                        }
                    });

                    if (listActuate) {
                        listActuate.map((dev) => {
                            listDevices.append('<option data-value="' + dev.id +
                                '" value="' + dev.label + ' (' + dev.id + ')"/>');
                        });
                    }

                    if (list.pagination.has_next) {
                        list_all(list.pagination.next_page);
                    }
                }).catch((error) => {
                    console.error('Failed to retrieve the list of available devices', error);
                });
            }

            $('#node-input-device_source').css('width', '70%');

            list_all();
        },
        oneditsave: function () {
            if ($('#node-input-device_source').val() === 'configured') {
                let deviceLabel = $('#node-input-device_source_id').val();

                let deviceId = $('#node-input-list_devices_id').find(
                    'option[value="' + deviceLabel + '"]').attr('data-value');

                if (!deviceId) {
                    $('#node-input-_device_id').val(undefined);
                } else {
                    $('#node-input-_device_id').val(deviceId);
                }
            } else {
                $('#node-input-_device_id').val(undefined);
            }
        }
    });

    function displayDeviceSourceElement() {
        var deviceSource = $('#node-input-device_source');
        var deviceSourceId = $('#node-input-device_source_id');
        var deviceSourceMsg = $('#node-input-device_source_msg');
        var deviceSourceIdLabel = $('#node-input-device_source_id_label');
        var deviceSourceMsgLabel = $('#node-input-device_source_msg_label');

        switch (deviceSource.val()) {
            case 'self':
                deviceSourceId.hide();
                deviceSourceMsg.hide();
                deviceSourceIdLabel.hide();
                deviceSourceMsgLabel.hide();
                break;
            case 'configured':
                deviceSourceId.show();
                deviceSourceMsg.hide();
                deviceSourceIdLabel.show();
                deviceSourceMsgLabel.hide();
                break;
            case 'dynamic':
                deviceSourceId.hide();
                deviceSourceMsg.show();
                deviceSourceIdLabel.hide();
                deviceSourceMsgLabel.show();
                break;
        }
    }

</script>

<script type="text/x-red" data-template-name="multi actuate">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-device_source"><i class="fa fa-gears"></i> <span data-i18n="label.action"></label>
        <select id="node-input-device_source" onchange="nodeDeviceOut_displayDeviceSourceElement()">
            <option value="self" data-i18n="text.triggered"></option>
            <option value="configured" data-i18n="text.specific"></option>
            <option value="dynamic" data-i18n="text.defined"></option>
        </select>
    </div>
    <div class="form-row" id="node-input-dynamic">
        <label for="node-input-devices_source_dynamic" id="node-input-devices_source_dynamic_label"><i class="fa fa-tag"></i> <span data-i18n="label.attribute"></label>
        <input type="text" id="node-input-devices_source_dynamic" data-i18n="[placeholder]text.enter_attribute" />
        <input type="hidden" id="node-input-devices_source_dynamicFieldType">
    </div>
    <div class="form-row" id="node-input-configured">
        <label for="form-row node-input-rule-container-row" id="node-input-devices_source_configured_label"><i class="fa fa-wifi"></i> <span data-i18n="label.devices"></label>
        <div class="form-row node-input-rule-container-row">
            <ol id="node-input-rule-container"></ol>
        </div>
        <datalist id="node-input-list_devices_id"></datalist>
    </div>
    <div class="form-row">
        <label for="node-input-attrs"><i class="fa fa-cube"></i> <span data-i18n="label.source"></label>
        <input type="text" id="node-input-attrs" style=""></input>
        <input type="hidden" id="node-input-msgFieldType">
    </div>

</script>

<script type="text/x-red" data-help-name="multi actuate">
    <p>Set the value of a virtual device, based on the results of the previous operations on the flow.</p>

</script>

<script type="text/javascript">
    var ACTUATOR = 'actuator';
    RED.nodes.registerType('multi actuate', {
        category: 'output',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: {value: '', required: false},
            device_source: {value: 'self', required: true},
            devices_source_dynamic: {value: '', required: false},
            devices_source_dynamicFieldType: {value: 'msg'},
            devices_source_configured: {value: [''], required: false},
            attrs: {value: '', required: true},

            // private
            _devices_loaded: {value: false, required: false}
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 0,               // set the number of outputs - 0 to n
        align: 'right',          // align the icon
        icon: 'bridge-dash.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/multi-actuate:title');
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/multi-actuate:title'),
        oneditprepare: function () {
            let node = this;
            let listDevices = $('#node-input-list_devices_id');
            nodeDeviceOut_displayDeviceSourceElement();

            if (!this.devices_source_dynamicFieldType) {
                this.devices_source_dynamicFieldType = 'msg';
            }
            $('#node-input-devices_source_dynamic').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-devices_source_dynamicFieldType')
            });

            $('#node-input-attrs').typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $('#node-input-msgFieldType')
            });

            // request to the device manager all devices
            function list_all(page) {
                return new Promise((resolve, reject) => {
                    if (page === undefined) {
                        page = 1;
                    }

                    var extra = `?page_num=${page}`
                    var orderByLabel = 'sortBy=label';

                    extra += '&' + orderByLabel;
                    var listActuate = [];
                    util.GET(`/device${extra}`).then((list) => {
                        list.devices.map((dev) => {
                            for (let template in dev.attrs) {
                                for (let attr of dev.attrs[template]) {
                                    if (attr.type === ACTUATOR) {
                                        listActuate.push(dev);
                                    }
                                }
                            }
                        });
                        if (listActuate) {
                            listActuate.map((dev) => {
                                listDevices.append('<option data-value="' + dev.id +
                                    '" value="' + dev.label + ' (' + dev.id + ')"/>');
                            });
                        }
                        if (list.pagination.has_next) {
                            return list_all(list.pagination.next_page).then(() => {
                                return resolve();
                            });
                        } else {
                            node._devices_loaded = true;
                            return resolve();
                        }
                    }).catch((error) => {
                        console.error('Failed to retrieve the list of available devices', error);
                        node._devices_loaded = false;
                        return reject();
                    });
                });
            }

            $('#node-input-device_source').css('width', '70%');

            list_all().then(() => {
                // define the rule box
                $('#node-input-rule-container').css('min-height', '150px').css('min-width', '450px').editableList({

                    addItem: function (container, index, data) {
                        let fieldConfig = {
                            type: 'text',
                            list: 'node-input-list_devices_id',
                            id: `node-input-device_source_id`,
                            placeholder: RED._('dojot/multi-actuate:text.select_device')
                        };

                        if (Object.entries(data).length > 0) {
                            let configuredDeviceEntry = $('#node-input-list_devices_id').find(
                                'option[data-value="' + data + '"]');
                            if (configuredDeviceEntry) {
                                fieldConfig.value = configuredDeviceEntry.attr('value');
                            } else {
                                fieldConfig.value = `Missing device: ${data}`;
                            }
                        }

                        $('<input/>', fieldConfig).appendTo(container);

                    },
                    sortable: true,
                    removable: true
                });

                // load the previous configuration
                for (let i = 0; i < node.devices_source_configured.length; ++i) {
                    $('#node-input-rule-container').editableList('addItem',
                        node.devices_source_configured[i]);
                }
            }).catch(() => {
                node._devices_loaded = false;
                console.log('Failed to retrieve devices from device manager');
            });

        },
        oneditsave: function () {
            let node = this;

            switch ($('#node-input-device_source').val()) {
                case 'configured':
                    node.devices_source_dynamic = '';

                    // skip save the devices due to problem with the device manager
                    // communication
                    if (!node._devices_loaded) {
                        console.log('Skipping save the devices');
                        return
                    }
                    // rebuilt the list with the devices ids
                    node.devices_source_configured = [];
                    let entries = $('#node-input-rule-container').editableList('items');
                    entries.each(function (i) {
                        let userLabel = this.find('#node-input-device_source_id').val();
                        let entry = $('#node-input-list_devices_id').find(
                            'option[value="' + userLabel + '"]');
                        if (entry) {
                            let deviceId = entry.attr('data-value');
                            if (deviceId) {
                                node.devices_source_configured.push(deviceId);
                            }
                        }

                    });
                    break;
                case 'self':
                    node.devices_source_configured = [''];
                    node.devices_source_dynamic = '';
                    break;
                case 'dynamic':
                    node.devices_source_configured = [''];
                    break;
            }
        }
    });

    function nodeDeviceOut_displayDeviceSourceElement() {
        let deviceSource = $('#node-input-device_source');
        let devicesSourceConfigured = $('#node-input-configured');
        let devicesSourceDynamic = $('#node-input-dynamic');

        switch (deviceSource.val()) {
            case 'self':
                devicesSourceConfigured.hide();
                devicesSourceDynamic.hide();
                break;
            case 'configured':
                devicesSourceConfigured.show();
                devicesSourceDynamic.hide();
                break;
            case 'dynamic':
                devicesSourceConfigured.hide();
                devicesSourceDynamic.show();
                break;
        }
    }

</script>

<script type="text/x-red" data-template-name="get context">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></label>
        <input type="text" id="node-input-name">
    </div>

    <!-- Input fields -->
    <div class="form-row">
        <label><i class="fa"></i> <span><span data-i18n="label.inputs"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-contextLayer"><i class="fa fa-edit"></i><span data-i18n="label.layer"></label>
        <select id="node-input-contextLayer">
            <option value="tenant"  data-i18n="label.tenant"></option>
            <option value="flow"  data-i18n="label.flow"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-contextName"><i class="fa fa-edit"></i> <span><span data-i18n="label.context_name"></span></label>
        <input type="text" id="node-input-contextName" data-i18n="[placeholder]label.context_name" style="width:250px;">
        <input type="hidden" id="node-input-contextNameType">
    </div>

    <!-- Output fields -->
    <div class="form-row">
        <label><i class="fa"></i> <span><span data-i18n="label.output"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-contextContent"><i class="fa fa-edit"></i> <span><span data-i18n="label.context_content"></span></label>
        <input type="text" id="node-input-contextContent" data-i18n="[placeholder]text.property_context" style="width:250px;">
    </div>

</script>

<script type="text/x-red" data-help-name="get context">
</script>

<script type="text/javascript">
    RED.nodes.registerType('get context', {
        category: RED._('dojot/get-context:category'),
        color: 'rgb(231, 231, 174)',
        defaults: {
            name: {value: '', required: false},
            contextLayer: {value: 'tenant', required: true},
            contextName: {required: true, validate: RED.validators.typedInput('contextNameType')},
            contextNameType: {value: 'str'},
            contextContent: {required: true}
        },
        inputs: 1,
        outputs: 1,
        icon: 'db.png',
        paletteLabel: RED._('dojot/get-context:title'),
        label: function () {
            return this.name || RED._('dojot/get-context:title');
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            if (!this.fieldType) {
                this.fieldType = 'str';
            }
            $('#node-input-contextName').typedInput({
                default: 'str',
                types: ['str', 'msg'],
                typeField: $('#node-input-contextNameType')
            });
        },
        oneditsave: function () {
        }
    });
</script>

<script type="text/javascript">
    RED.nodes.registerType('cron', {
        // (string) the palette category the node appears in
        category: 'function',
        // (string) the icon to use
        icon: 'timer.png',
        // (string) the background colour to use
        color: '#71c4b1',
        // (number) how many inputs the node has, either 0 or 1
        inputs: 1,
        // (number) how many outputs the node has. Can be 0 or more.
        outputs: 1,
        inputLabels: 'in',
        outputLabels: ['out'],
        // (object) the editable properties for the node
        defaults: {
            name: {
                value: '',
                required: false
            },
            operation: {
                value: 'CREATE',
                required: true
            },
            cronTimeExpression: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'CREATE') {
                        let cronregex = new RegExp(/^(\*|(([0-9])|([0-5][0-9]))(((\,)(([0-9])|([0-5][0-9])))*)?(\/(([0-9])|([0-5][0-9])))?) (\*|(([0-9])|(1[0-9]|2[0-3]))(((\,)(([0-9])|(1[0-9]|2[0-3])))*)?(\/(([0-9])|(1[0-9]|2[0-3])))?) (\*|(([0-9])|(1[0-9]|2[0-9]|3[01]))(((\,)((0-9)|(1[0-9]|2[0-9]|3[01]))*))?(\/(([0-9])|(1[0-9]|2[0-9]|3[01])))?) (\*|(([0-9])|(0[0-9]|1[0-2]))(((\,)(([0-9])|(0[0-9]|1[0-2])))*)?(\/(([0-9])|(0[0-9]|1[0-2])))?) (\*|(([0-7])|(0[0-7]))((\,)(([0-7])|(0[0-7]))*)?(\/(([0-7])|(0[0-7])))?)$/);
                        return cronregex.test(v);
                    }
                    return true;
                }
            },
            jobName: {
                value: ''
            },
            jobDescription: {
                value: ''
            },
            jobType: {
                value: 'EVENT REQUEST',
                required: true
            },
            jobAction: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'CREATE') {
                        if (v === '') {
                            return false;
                        }
                    }
                    return RED.validators.typedInput('jobActionType');
                }
            },
            jobActionType: {
                value: 'msg'
            },
            inJobId: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'REMOVE') {
                        if (v === '') {
                            return false;
                        }
                    }
                    return RED.validators.typedInput('inJobIdType');
                }
            },
            inJobIdType: {
                value: 'msg'
            },
            outJobId: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'CREATE') {
                        if (v === '') {
                            return false;
                        }
                    }
                    return RED.validators.typedInput('outJobIdType');
                }
            },
            outJobIdType: {
                value: 'msg'
            }
        },
        // (string|function) the label to use in the workspace
        label: function () {
            return this.name || RED._('dojot/cron:label.cron')
        },
        //
        oneditprepare: function () {
            $('#node-input-outJobId').typedInput({
                default: 'msg',
                typeField: $('#node-input-outJobIdType'),
                types: ['msg']
            });
            $('#node-input-inJobId').typedInput({
                default: 'msg',
                typeField: $('#node-input-inJobIdType'),
                types: ['msg']
            });
            $('#node-input-jobAction').typedInput({
                default: 'msg',
                typeField: $('#node-input-jobActionType'),
                types: ['msg']
            });

            $('#node-input-operation').change(function () {
                if ($('#node-input-operation option:selected').val() === 'CREATE') {
                    $('#node-operation-create-cronTimeExpression').show();
                    $('#node-operation-create-jobName').show();
                    $('#node-operation-create-jobDescription').show();
                    $('#node-operation-create-jobType').show();
                    $('#node-operation-remove-inJobId').hide();
                    $('#node-operation-create-jobAction').show();
                    $('#node-operation-create-outJobId').show();
                } else if ($('#node-input-operation option:selected').val() === 'REMOVE') {
                    $('#node-operation-create-cronTimeExpression').hide();
                    $('#node-operation-create-jobName').hide();
                    $('#node-operation-create-jobDescription').hide();
                    $('#node-operation-create-jobType').hide();
                    $('#node-operation-remove-inJobId').show();
                    $('#node-operation-create-jobAction').hide();
                    $('#node-operation-create-outJobId').hide();
                }
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="cron">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]label.name">
    </div>
    <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-tasks"></i> <span data-i18n="label.operation"></span></label>
        <select type="text" id="node-input-operation" style="width:70%;">
            <option value="CREATE">CREATE</option>
            <option value="REMOVE">REMOVE</option>
        </select>
    </div>
    <div class="form-row" id="node-operation-create-cronTimeExpression">
        <label for="node-input-cronTimeExpression"><i class="fa fa-clock-o"></i> <span data-i18n="label.cronTimeExpression"></span></label>
        <input type="text" id="node-input-cronTimeExpression" data-i18n="[placeholder]timeExpressionExample">
    </div>
    <div class="form-row" id="node-operation-create-jobName">
        <label for="node-input-jobName"><i class="fa fa-tag"></i> <span data-i18n="label.jobName"></span></label>
        <input type="text" id="node-input-jobName" data-i18n="[placeholder]label.jobName">
    </div>
    <div class="form-row" id="node-operation-create-jobDescription">
        <label for="node-input-jobDescription"><i class="fa fa-pencil-square-o"></i> <span data-i18n="label.jobDescription"></span></label>
        <input type="text" id="node-input-jobDescription" data-i18n="[placeholder]label.jobDescription">
    </div>
    <div class="form-row" id="node-operation-create-jobType">
        <label for="node-input-jobType"><i class="fa fa-tasks"></i> <span data-i18n="label.jobType"></span></label>
        <select type="text" id="node-input-jobType" style="width:70%;">
            <option value="EVENT REQUEST">EVENT REQUEST</option>
            <option value="HTTP REQUEST">HTTP REQUEST</option>
        </select>
    </div>
    <div class="form-row" id="node-operation-create-jobAction">
        <label for="node-input-jobAction"><i class="fa fa-code"></i> <span data-i18n="label.jobAction"></span></label>
        <input type="text" id="node-input-jobAction" data-i18n="[placeholder]jobActionKey">
        <input type="hidden" id="node-input-jobActionType">
    </div>
    <div class="form-row" id="node-operation-remove-inJobId">
        <label for="node-input-inJobId"><i class="fa fa-tag"></i> <span data-i18n="label.inJobId"></span></label>
        <input type="text" id="node-input-inJobId" data-i18n="[placeholder]inJobIdKey">
        <input type="hidden" id="node-input-inJobIdType">
    </div>
    <div class="form-row" id="node-operation-create-outJobId">
            <label for="node-input-outJobId"><i class="fa fa-arrow-circle-o-left "></i> <span data-i18n="label.outJobId"></span></label>
            <input type="text" id="node-input-outJobId" data-i18n="[placeholder]outJobIdKey">
            <input type="hidden" id="node-input-outJobIdType">
    </div>


</script>

<script type="text/x-red" data-help-name="cron">
</script>

<script type="text/javascript">
    RED.nodes.registerType('cron-batch', {
        // (string) the palette category the node appears in
        category: 'function',
        // (string) the icon to use
        icon: 'timer.png',
        // (string) the background colour to use
        color: '#519989',
        // (number) how many inputs the node has, either 0 or 1
        inputs: 1,
        // (number) how many outputs the node has. Can be 0 or more.
        outputs: 1,
        inputLabels: 'in',
        outputLabels: ['out'],
        // (object) the editable properties for the node
        defaults: {
            name: {
                value: '',
                required: false
            },
            operation: {
                value: 'CREATE',
                required: true
            },
            jobs: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'CREATE') {
                        if (v === '') {
                            return false;
                        }
                    }
                    return RED.validators.typedInput('jobsType');
                }
            },
            jobsType: {
                value: 'msg'
            },
            inJobIds: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'REMOVE') {
                        if (v === '') {
                            return false;
                        }
                    }
                    return RED.validators.typedInput('inJobIdsType');
                }
            },
            inJobIdsType: {
                value: 'msg'
            },
            outJobIds: {
                value: '',
                validate: function (v) {
                    if ($('#node-input-operation option:selected').val() === 'CREATE') {
                        if (v === '') {
                            return false;
                        }
                    }
                    return RED.validators.typedInput('outJobIdsType');
                }
            },
            outJobIdsType: {
                value: 'msg'
            },
            timeout: {
                value: 1000,
                validate: RED.validators.number()
            }
        },
        // (string|function) the label to use in the workspace
        label: function () {
            return this.name || RED._('dojot/cron-batch:label.cron-batch')
        },
        //
        oneditprepare: function () {
            $('#node-input-jobs').typedInput({
                default: 'msg',
                typeField: $('#node-input-jobsType'),
                types: ['msg']
            });
            $('#node-input-inJobIds').typedInput({
                default: 'msg',
                typeField: $('#node-input-inJobIdsType'),
                types: ['msg']
            });
            $('#node-input-outJobIds').typedInput({
                default: 'msg',
                typeField: $('#node-input-outJobIdsType'),
                types: ['msg']
            });

            $('#node-input-operation').change(function () {
                if ($('#node-input-operation option:selected').val() === 'CREATE') {
                    $('#node-operation-create-jobs').show();
                    $('#node-operation-remove-inJobIds').hide();
                    $('#node-operation-create-outJobIds').show();
                } else if ($('#node-input-operation option:selected').val() === 'REMOVE') {
                    $('#node-operation-create-jobs').hide();
                    $('#node-operation-remove-inJobIds').show();
                    $('#node-operation-create-outJobIds').hide();
                }
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="cron-batch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]label.name">
    </div>
    <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-tasks"></i> <span data-i18n="label.operation"></span></label>
        <select type="text" id="node-input-operation" style="width:70%;">
            <option value="CREATE">CREATE</option>
            <option value="REMOVE">REMOVE</option>
        </select>
    </div>
    <div class="form-row" id="node-operation-create-jobs">
        <label for="node-input-jobs"><i class="fa fa-arrow-circle-o-right"></i> <span data-i18n="label.jobs"></span></label>
        <input type="text" id="node-input-jobs" data-i18n="[placeholder]jobsKey">
        <input type="hidden" id="node-input-jobsType">
    </div>
    <div class="form-row" id="node-operation-remove-inJobIds">
        <label for="node-input-inJobIds"><i class="fa fa-arrow-circle-o-right"></i> <span data-i18n="label.inJobIds"></span></label>
        <input type="text" id="node-input-inJobIds" data-i18n="[placeholder]inJobIdsKey">
        <input type="hidden" id="node-input-inJobIdsType">
    </div>
    <div class="form-row" id="node-operation-create-outJobIds">
        <label for="node-input-outJobIds"><i class="fa fa-arrow-circle-o-left"></i> <span data-i18n="label.outJobIds"></span></label>
        <input type="text" id="node-input-outJobIds" data-i18n="[placeholder]outJobIdsKey">
        <input type="hidden" id="node-input-outJobIdsType">
    </div>
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-tag"></i> <span data-i18n="label.timeout"></span></label>
        <input type="text" id="node-input-timeout">
    </div>

</script>

<script type="text/x-red" data-help-name="cron-batch">
</script>
<script type="text/x-red" data-template-name="cumulative sum">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="config.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-timePeriod"><i class="fa fa-clock-o"></i> <span data-i18n="config.time_period"></label>
        <input type="text" id="node-input-timePeriod" style="width:250px;">
    </div>
    <div class="form-row">
        <label for="node-input-targetAttribute"><i class="fa fa-cube"></i> <span data-i18n="config.target_attribute"></label>
        <input type="text" id="node-input-targetAttribute" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row">
        <label for="node-input-timestamp"><i class="fa fa-cube"></i> <span data-i18n="config.timestamp"></label>
        <input type="text" id="node-input-timestamp" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-arrow-left"></i> <span data-i18n="config.output"></label>
        <input type="text" id="node-input-output" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>

</script>

<script type="text/x-red" data-help-name="cumulative sum">
    <p>A simple node that computes the cumulative sum of a given attribute
        in a given temporal window.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('cumulative sum', {
        category: 'function',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: {value: '', required: false},
            timePeriod: {
                value: undefined, required: true, validate: function (value) {
                    if (isNaN(value) || (value <= 0)) {
                        return false;
                    }
                    return true;
                }
            },
            targetAttribute: {value: undefined, required: true},
            timestamp: {value: undefined, required: true},
            output: {value: undefined, required: true},
            fieldType: {value: 'msg'},
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: 'left',          // align the icon
        icon: 'function.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/cumulative-sum:title');
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/cumulative-sum:title'),
        oneditprepare: function () {
            let msgAttrs = ['targetAttribute', 'timestamp', 'output'];

            for (let attr of msgAttrs) {
                $('#node-input-' + attr).typedInput({
                    default: 'msg',
                    types: ['msg'],
                    typeField: $('#node-input-fieldType')
                });
            }
        },
        oneditsave: function () {

        }
    });

</script>

<script type="text/x-red" data-template-name="merge data">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="config.name"></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-targetData"><i class="fa fa-cube"></i> <span data-i18n="config.target_data"></label>
        <input type="text" id="node-input-targetData" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row">
        <label for="node-input-mergedData"><i class="fa fa-arrow-left"></i> <span data-i18n="config.merged_data"></label>
        <input type="text" id="node-input-mergedData" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>

</script>

<script type="text/x-red" data-help-name="merge data">
    <p></p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('merge data', {
        category: 'function',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: {value: '', required: false},
            targetData: {value: undefined, required: true},
            mergedData: {value: undefined, required: true},
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: 'left',          // align the icon
        icon: 'function.png', // set the icon (held in icons dir below where you save the node)
        color: '#f3b567',        // background-color
        label: function () {
            // sets the default label contents
            return this.name || RED._('dojot/merge-data:title');
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: RED._('dojot/merge-data:title'),
        oneditprepare: function () {
            let msgAttrs = ['targetData', 'mergedData'];

            for (let attr of msgAttrs) {
                $('#node-input-' + attr).typedInput({
                    default: 'msg',
                    types: ['msg'],
                    typeField: $('#node-input-fieldType')
                });
            }
        },
        oneditsave: function () {
        }
    });

</script>